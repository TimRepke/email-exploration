<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="css/bootstrap.css" rel="stylesheet"/>
    <link href="css/bootstrap-theme.css" rel="stylesheet"/>
    <style>
        .bordered {
            padding-top: 15px;
            padding-bottom: 15px;
            border: 1px solid #ddd;
        }

        html, body, .container-fluid {
            height: 100%;
        }

        .fill {
            min-height: 100%;
            height: 100%;
        }

        #graph {
            height: 100%;
            width: 100%;
            border: 1px solid silver;
        }

        #wordcloud_canvas {
            margin: 0;
            padding: 0;
        }

        *[hidden] {
            display: none;
        }

        .hoverbox {
            border: 1px dashed gray;
            position: absolute;
            border-radius: 10px;
            pointer-events:none;
        }
        #wordcloud_selectbox {
            border: 1px solid gray;
        }
        #wordcloud_clear {
            width: 15px;
            height: 15px;
            font-weight: bold;
            position: absolute;
            top: 5px;
            left: 5px;
            border: 1px solid gray;
            font-size: 15px;
            text-align: center;
            padding: 0;
            line-height: 11px;
            cursor: pointer;
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row" style="height: 100%">
        <div class="col-md-6 bordered" style="height: 100%">
            <div id="graph">

            </div>
        </div>
        <div class="col-md-6" style="height: 100%">
            <div class="row" style="height: 50%">
                <div class="col-md-12 bordered" style="height: 100%; padding:0;">
                    <canvas id="wordcloud_canvas" class="canvas"></canvas>
                    <div id="wordcloud_clear">x</div>
                </div>
            </div>
            <div class="row" style="height: 50%">
                <div class="col-md-12 bordered" style="height: 100%; overflow-y: scroll;">
                    <div class="list-group" id="mail_list">

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript" src="js/vis.min.js"></script>
<script type="text/javascript" src="js/wordcloud2.js"></script>
<script type="text/javascript">

    let wordcloud_canvas = document.getElementById("wordcloud_canvas");
    wordcloud_canvas.height = wordcloud_canvas.parentElement.clientHeight;
    wordcloud_canvas.width = wordcloud_canvas.parentElement.clientWidth;

    function spawn_box(id, padding) {
        let hoverbox = document.createElement('div');
        hoverbox.setAttribute('hidden', '');
        hoverbox.setAttribute('class', 'hoverbox');
        hoverbox.setAttribute('id', id);
        wordcloud_canvas.parentNode.appendChild(hoverbox);
        return {
            setDimension: function(dimension) {
                hoverbox.style.left = dimension.x - padding/2 + 'px';
                hoverbox.style.top = dimension.y - padding/2 + 'px';
                hoverbox.style.width = dimension.w + padding + 'px';
                hoverbox.style.height = dimension.h + padding + 'px';
            },
            hide: function() {
                hoverbox.setAttribute('hidden', '');
            },
            show: function() {
                hoverbox.removeAttribute('hidden');
            }
        }
    }

    let hoverbox = spawn_box('wordcloud_hoverbox', 10);
    let selectbox = spawn_box('wordcloud_selectbox', 10);
    document.getElementById("wordcloud_clear").addEventListener("click",function (){
        selectbox.hide();
    });

    WordCloud(wordcloud_canvas, {
        gridSize: Math.round(12 * wordcloud_canvas.width / 1024),
        weightFactor: function (size) {
            return size * 3 * wordcloud_canvas.width / 1024;
        },
        fontFamily: 'cursive, sans-serif',
        color: '#222',
        //hover: window.drawBox,
        rotateRatio: 0,
        drawOutOfBound: false,
        click: function (item, dimension, evt) {
            console.log('ads')
            selectbox.show();

            selectbox.setDimension(dimension);
            alert(item[0] + ': ' + item[1]);
        },
        hover: function (item, dimension, evt) {
            if (!dimension) {
                hoverbox.hide();
                return;
            }
            hoverbox.show();
            hoverbox.setDimension(dimension);
        },
        backgroundColor: '#fff',
        list: [["Enron", 27],
            ["PG&E", 15],
            ["Morgan Stanley", 14],
            ["UBS", 18],
            ["EnronOnline", 9],
            ["SAP", 8],
            ["MasterCard", 13],
            ["Wiley", 11],
            ["Nevada Power", 10],
            ["California", 9],
            ["Sierra Pacific", 12],
            ["FTC", 8],
            ["PJM", 13], ["Enron", 27],
            ["PG&E", 15],
            ["Morgan Stanley", 14],
            ["UBS", 18],
            ["EnronOnline", 9],
            ["SAP", 8],
            ["MasterCard", 13],
            ["Wiley", 11],
            ["Nevada Power", 10],
            ["California", 9],
            ["Sierra Pacific", 12],
            ["FTC", 8],
            ["PJM", 13]]
    });

    // create an array with nodes
    function jsonReq(theUrl) {
        return new Promise(function (resolve, reject) {
            let xmlHttp = new XMLHttpRequest();
            xmlHttp.onreadystatechange = function () {
                if (xmlHttp.readyState === 4 && xmlHttp.status === 200) {
                    resolve(JSON.parse(xmlHttp.responseText));
                } else if (xmlHttp.readyState === 4 && xmlHttp.status !== 200) {
                    reject(new Error("Received HTTP Status " + xmlHttp.status));
                }
            };
            xmlHttp.open("GET", theUrl, true); // true for asynchronous
            xmlHttp.send(null);
        });
    }

    function drawGraph(nodes, edges) {

        let v_nodes = new vis.DataSet(Object.keys(nodes).map(function (key, i) {
            let val = nodes[key];
            return {
                id: val.i, value: val.in + val.out,
                label: (val.address || 'no@mail.com') + ' - ' + (val.name || 'no name'),
                chosen: {
                    label: function (ctx, values, id) {
                        console.log(values);
                        values.size += 20;
                    },
                    node: true
                }
            };
        }));
        console.log('processed nodes');
        let v_edges = new vis.DataSet(edges.map(function (val, i) {
            return {
                from: nodes[val.from].i, to: nodes[val.to].i, value: val.cnt,
                arrows: {to: {enabled: true, scaleFactor: 0.5, type: 'arrow'}}
            };
        }));
        console.log('processed edges');

        // create a network
        let container = document.getElementById('graph');
        let data = {
            nodes: v_nodes,
            edges: v_edges
        };
        let options = {
            interaction: {
                hover: true
            },
            layout: {
                improvedLayout: false
            },
            physics: {
                barnesHut: {
                    avoidOverlap: 0.3,
                    "gravitationalConstant": -1500,
                    "springLength": 100,
                    "springConstant": 0.04,
                    "damping": 0.2
                },
                stabilization: {
                    iterations: 10,
                    enabled: false
                }
                //solver: 'forceAtlas2Based'
            },
            nodes: {
                shape: 'dot',
                scaling: {
                    label: {
                        min: 8,
                        max: 30
                    }
                }
            }
        };
        let network = new vis.Network(container, data, options);
    }

    jsonReq('http://localhost:8080/graph/mails').then(function (res) {
        let l = document.getElementById('mail_list');
        let html = "";
        res.forEach(function (m) {
            html += '<a href="#" class="list-group-item"> ' +
                '<h4 class="list-group-item-heading">' + m['sub'] + '</h4> ' +
                '<p class="list-group-item-text">' +
                '<i>' + m['from'] + ' - ' + m['to'] + '</i><br/>' +
                m['msg'] +
                '</p> ' +
                '</a>';
        });
        l.innerHTML = html;
    });
    /*
     jsonReq("http://localhost:8080/graph/star?uid=users/11405029&depth=2&direction=2").then(function (res) {
     console.log("received " + Object.keys(res.nodes).length + " nodes and " + res.edges.length + " edges");
     drawGraph(res.nodes, res.edges)
     }).catch(function (err) {
     console.error(err.stack);
     });
     */
</script>
<!--script type="text/javascript" src="js/bootstrap.js"></script-->
</body>
</html>