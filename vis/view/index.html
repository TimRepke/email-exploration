<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="css/bootstrap.css" rel="stylesheet"/>
    <link href="css/bootstrap-theme.css" rel="stylesheet"/>
    <style>
        .bordered {
            padding-top: 15px;
            padding-bottom: 15px;
            border: 1px solid #ddd;
        }

        html, body, .container-fluid {
            height: 100%;
        }

        .fill {
            min-height: 100%;
            height: 100%;
        }

        #graph {
            height: 100%;
            width: 100%;
            border: 1px solid silver;
        }

        #wordcloud_canvas {
            margin: 0;
            padding: 0;
            display: none;
        }
        #wcc > svg {
            margin: 0;
            padding: 0;
        }

        #wcc svg text {
            border: 1px dashed grey;
        }

        *[hidden] {
            display: none;
        }

        .hoverbox {
            border: 1px dashed gray;
            position: absolute;
            border-radius: 10px;
            pointer-events:none;
        }
        #wordcloud_selectbox {
            border: 1px solid gray;
        }
        .cloudbutton {
            width: 18px;
            height: 18px;
            font-weight: bold;
            border: 1px solid gray;
            text-align: center;
            font-size: 14px;
            padding: 1px 0 0 0;
            cursor: pointer;
            position: absolute;
            top: 5px;
            left: 5px;
        }
        .cloudbutton:hover {
            background-color: #E9E9E9;
        }
        #wordcloud_filters {
            position: absolute;
            bottom: 10px;
            left: 10px;
        }
        #wordcloud_filters > span {
            float: left;
            padding: 2px;
            margin: 0 1px;
            border: 1px solid darkgrey;
            cursor: pointer;
        }
        #wordcloud_filters > span:hover {
            background-color: silver;
        }
        #wordcloud_filters > span .active {
            text-decoration: underline;
        }
    </style>
</head>
<body>
<div class="container-fluid">
    <div class="row" style="height: 100%">
        <div class="col-md-6 bordered" style="height: 100%">
            <div id="graph">

            </div>
        </div>
        <div class="col-md-6" style="height: 100%">
            <div class="row" style="height: 50%">
                <div class="col-md-12 bordered" style="height: 100%; padding:0;overflow:hidden" id="wcc" >
                    <span id="wordcloud_clear" class="cloudbutton glyphicon glyphicon-remove" aria-hidden="true"></span>
                    <span id="wordcloud_center" class="cloudbutton glyphicon glyphicon-screenshot" aria-hidden="true" style="left:25px;"></span>
                    <div id="wordcloud_filters"></div>
                </div>
            </div>
            <div class="row" style="height: 50%">
                <div class="col-md-12 bordered" style="height: 100%; overflow-y: scroll;">
                    <div class="list-group" id="mail_list">

                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript" src="https://www.jasondavies.com/d3.min.js"></script>
<script type="text/javascript" src="js/vis.min.js"></script>
<script type="text/javascript" src="js/d3.layout.cloud.js"></script>
<script type="text/javascript" src="js/color.js"></script>
<script type="text/javascript" src="js/wordcloud.js"></script>
<!--script type="text/javascript" src="js/wordcloud2.js"></script-->
<script type="text/javascript">
    let woc = new WordCloud('http://localhost:8080/graph/entities', 'wcc');
/*
    document.getElementById('test').addEventListener('click', function(e) {
        console.log('ORG')
        woc.drawReq({types:['ORG']});
    });
*/
    //woc.re
    let wc;
    function makeCloud(list) {
        let wordcloud_canvas = document.getElementById("wordcloud_canvas");
        wordcloud_canvas.height = wordcloud_canvas.parentElement.clientHeight;
        wordcloud_canvas.width = wordcloud_canvas.parentElement.clientWidth;

        function spawn_box(id, padding) {
            let hoverbox = document.createElement('div');
            hoverbox.setAttribute('hidden', '');
            hoverbox.setAttribute('class', 'hoverbox');
            hoverbox.setAttribute('id', id);
            wordcloud_canvas.parentNode.appendChild(hoverbox);
            return {
                setDimension: function(dimension) {
                    hoverbox.style.left = dimension.x - padding/2 + 'px';
                    hoverbox.style.top = dimension.y - padding/2 + 'px';
                    hoverbox.style.width = dimension.w + padding + 'px';
                    hoverbox.style.height = dimension.h + padding + 'px';
                },
                hide: function() {
                    hoverbox.setAttribute('hidden', '');
                },
                show: function() {
                    hoverbox.removeAttribute('hidden');
                }
            }
        }

        let hoverbox = spawn_box('wordcloud_hoverbox', 10);
        let selectbox = spawn_box('wordcloud_selectbox', 10);
        document.getElementById("wordcloud_clear").addEventListener("click",function (){
            selectbox.hide();
        });

        wc = WordCloud(wordcloud_canvas, {
            gridSize: Math.round(12 * wordcloud_canvas.width / 1024),
            weightFactor: function (size) {
                return size * 3 * wordcloud_canvas.width / 1024;
            },
            fontFamily: 'cursive, sans-serif',
            color: '#222',
            //hover: window.drawBox,
            rotateRatio: 0,
            drawOutOfBound: false,
            click: function (item, dimension, evt) {
                selectbox.show();

                selectbox.setDimension(dimension);
                alert(item[0] + ': ' + item[1]);
            },
            hover: function (item, dimension, evt) {
                if (!dimension) {
                    hoverbox.hide();
                    return;
                }
                hoverbox.show();
                hoverbox.setDimension(dimension);
            },
            backgroundColor: '#fff',
            list: list,
            scroll: 'zoom'
        });
    }

    // create an array with nodes
    function jsonReq(theUrl) {
        return new Promise(function (resolve, reject) {
            let xmlHttp = new XMLHttpRequest();
            xmlHttp.onreadystatechange = function () {
                if (xmlHttp.readyState === 4 && xmlHttp.status === 200) {
                    resolve(JSON.parse(xmlHttp.responseText));
                } else if (xmlHttp.readyState === 4 && xmlHttp.status !== 200) {
                    reject(new Error("Received HTTP Status " + xmlHttp.status));
                }
            };
            xmlHttp.open("GET", theUrl, true); // true for asynchronous
            xmlHttp.send(null);
        });
    }

    function drawGraph(nodes, edges) {

        let v_nodes = new vis.DataSet(Object.keys(nodes).map(function (key, i) {
            let val = nodes[key];
            return {
                id: val.i, value: val.in + val.out,
                label: (val.address || 'no@mail.com') + ' - ' + (val.name || 'no name'),
                chosen: {
                    label: function (ctx, values, id) {
                        console.log(values);
                        values.size += 20;
                    },
                    node: true
                }
            };
        }));
        console.log('processed nodes');
        let v_edges = new vis.DataSet(edges.map(function (val, i) {
            return {
                from: nodes[val.from].i, to: nodes[val.to].i, value: val.cnt,
                arrows: {to: {enabled: true, scaleFactor: 0.5, type: 'arrow'}}
            };
        }));
        console.log('processed edges');

        // create a network
        let container = document.getElementById('graph');
        let data = {
            nodes: v_nodes,
            edges: v_edges
        };
        let options = {
            interaction: {
                hover: true
            },
            layout: {
                improvedLayout: false
            },
            physics: {
                barnesHut: {
                    avoidOverlap: 0.3,
                    "gravitationalConstant": -1500,
                    "springLength": 100,
                    "springConstant": 0.04,
                    "damping": 0.2
                },
                stabilization: {
                    iterations: 10,
                    enabled: false
                }
                //solver: 'forceAtlas2Based'
            },
            nodes: {
                shape: 'dot',
                scaling: {
                    label: {
                        min: 8,
                        max: 30
                    }
                }
            }
        };
        let network = new vis.Network(container, data, options);
    }
    /*

    jsonReq('http://localhost:8080/graph/entities?min_cnt=2&types=ORG,PERSON').then(function (res) {

//        makeCloud(res.map(function(e) {
//            return [e['name'], e['cnt']]
//        }));
//
//         transform: scale(2,2);
//         transform-origin: -50% -50%;


        let fill = d3.scale.category20();

        let layout = d3.layout.cloud()
            .size([document.getElementById('wcc').clientWidth, document.getElementById('wcc').clientHeight])
            .words(res.map(function(e) {
                return {text: e['name'], size: e['cnt']};
            }))
            .padding(1)
            .rotate(0)
            .fontSize(function(d) {
                //return Math.sqrt(d.size + 8);
                return d.size * 3;
                //return Math.log(d.size);
            })
            .on('end', function draw(words) {
                console.log('asd')
                d3.select('#wcc').insert("svg", ":first-child")
                    .attr("width", layout.size()[0])
                    .attr("height", layout.size()[1])
                    .append("g")
                    .attr("transform", "translate(" + layout.size()[0] / 2 + "," + layout.size()[1] / 2 + ")")
                    .selectAll("text")
                    .data(words)
                    .enter().append("text")
                    .style("font-size", function(d) { return d.size + "px"; })
                    .style("font-family", "Impact")
                    .style("fill", function(d, i) { return fill(i); })
                    .attr("text-anchor", "middle")
                    .attr("transform", function(d) {
                        return "translate(" + [d.x, d.y] + ")rotate(" + d.rotate + ")";
                    })
                    .text(function(d) { return d.text; });

                let wcc_svg = document.querySelector("#wcc svg");
                wcc_svg.style.setProperty('cursor', 'pointer');
                let scale = 1;
                let transX = 0, transY = 0;
                wcc_svg.addEventListener('mousewheel', function (e) {
                    let up = e.deltaY < 0;
                    scale = Math.max(1, (scale + (up ? +1 : -1) * Math.log(scale+0.1)));
                    wcc_svg.style.transform = 'translate('+transX+'px, '+transY+'px) scale('+scale+')';
                });
                wcc_svg.addEventListener('mousedown', function(e) {
                    let startX = e.clientX, startY = e.clientY;
                    let transX_old = transX, transY_old = transY;
                    e.preventDefault();

                    let onmove = function(e) {
                        transX = transX_old - (startX - e.clientX);
                        transY = transY_old - (startY - e.clientY);
                        wcc_svg.style.transform = 'translate('+transX+'px, '+transY+'px) scale('+scale+')';
                    };
                    let onup = function(e) {
                        document.removeEventListener('mousemove', onmove);
                        document.removeEventListener('mouseup', onup);
                    };
                    document.addEventListener('mousemove', onmove);
                    document.addEventListener('mouseup', onup);
                });

                document.getElementById("wordcloud_center").addEventListener('click', function(e) {
                    transX = 0;
                    transY = 0;
                    scale = 1;
                    wcc_svg.style.transform = 'translate('+transX+'px, '+transY+'px) scale('+scale+')';
                });

                function spawn_rect({dashed=false} = {}) {
                    let rect = document.createElementNS("http://www.w3.org/2000/svg", 'rect');
                    let hidden = false;
                    rect.setAttributeNS(null, 'fill', 'none');
                    if (dashed) {
                        rect.setAttributeNS(null, 'stroke-dasharray', '5,5');
                    }
                    rect.setAttributeNS(null, 'stroke', 'black');
                    rect.setAttributeNS(null, 'stroke-width', '2');
                    document.querySelector('#wcc > svg > g').appendChild(rect);

                    return {
                        show: function() {
                            rect.style.setProperty('display', '');
                            hidden = false;
                        },
                        isHidden: function() {
                            return hidden;
                        },
                        hide: function() {
                            rect.style.setProperty('display', 'none');
                            hidden = true;
                        },
                        pos: function({x, y, height, width, transform}) {
                            let trans = transform.match(/translate\((-?\d+),(-?\d+)\).*rotate\((-?\d+)\)/);
                            trans = {x: trans[1] || 0, y: trans[2] || 0, rotate: trans[3] || 0};
                            rect.setAttributeNS(null, 'x', x);
                            rect.setAttributeNS(null, 'y', y);
                            rect.setAttributeNS(null, 'height', height);
                            rect.setAttributeNS(null, 'width', width);
                            rect.setAttributeNS(null, 'transform', 'translate('+trans.x+','+trans.y+')rotate('+trans.rotate+')');
                        }
                    }
                }
                function getEventPos(e) {
                    let bounds = e.target.getBBox();
                    let trans = e.target.getAttribute('transform').match(/translate\((-?\d+),(-?\d+)\).*rotate\((-?\d+)\)/);
                    trans = {x: trans[1] || 0, y: trans[2] || 0, rotate: trans[3] || 0};

                    console.log(e.target)
                    console.log(bounds)

                    return {
                        x: bounds.x,
                        y: bounds.y,
                        height: bounds.height,
                        width: bounds.width,
                        transform: e.target.getAttribute('transform'),
                        trans: trans
                    }
                }

                let last_hovered = undefined;
                let hover_rect = spawn_rect({dashed: true});
                let click_rect = spawn_rect();

                function monochromatic(RGBcolour, percentage) {
                    RGBcolour = RGBcolour.split(',');
                    let orig = $ui.color.rgb2hex([parseInt(RGBcolour[0].substring(4)), parseInt(RGBcolour[1]), parseInt(RGBcolour[2].slice(0, -1))]);
                    return 'rgb('+$ui.color.hex2rgb($ui.color.percentage(percentage, orig, $ui.color.complement(orig))).join(',')+')';
                }
                document.getElementById("wordcloud_clear").addEventListener('click', function(e) {
                    click_rect.hide();
                    hover_rect.hide();
                });

                wcc_svg.addEventListener('mousemove', function (e) {
                    if (hover_rect.isHidden()) {
                        hover_rect.show();
                    }
                    if (e.target && e.target.tagName === 'text' && e.target !== last_hovered){
                        e.target.style.fill = monochromatic(e.target.style.fill, 0.2);
                        if(last_hovered) last_hovered.style.fill = monochromatic(last_hovered.style.fill, 0.2);
                        last_hovered = e.target;

                        hover_rect.pos(getEventPos(e))
                    }
                    a = e.target
                });
                wcc_svg.addEventListener('mouseleave', function (e) {
                    last_hovered = undefined;
                   // hover_rect.hide()
                });
                wcc_svg.addEventListener('click', function(e) {
                    click_rect.show();
                    click_rect.pos(getEventPos(e));
                });
            });
        layout.start();
    });
    */

    jsonReq('http://localhost:8080/graph/mails').then(function (res) {
        let l = document.getElementById('mail_list');
        let html = "";
        res.forEach(function (m) {
            html += '<a href="#" class="list-group-item"> ' +
                '<h4 class="list-group-item-heading">' + m['sub'] + '</h4> ' +
                '<p class="list-group-item-text">' +
                '<i>' + m['from'] + ' - ' + m['to'] + '</i><br/>' +
                m['msg'] +
                '</p> ' +
                '</a>';
        });
        l.innerHTML = html;
    });
/*
     jsonReq("http://localhost:8080/graph/star?uid=users/11405029&depth=2&direction=2").then(function (res) {
     console.log("received " + Object.keys(res.nodes).length + " nodes and " + res.edges.length + " edges");
     drawGraph(res.nodes, res.edges)
     }).catch(function (err) {
     console.error(err.stack);
     });
*/
</script>
<!--script type="text/javascript" src="js/bootstrap.js"></script-->
</body>
</html>